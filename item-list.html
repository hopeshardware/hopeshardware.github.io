<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>HOPES hardware</title><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
	<link rel="stylesheet" href="css/reset.css">
	<link rel="stylesheet" href="css/common.css">
	<link rel="stylesheet" href="css/item-list.css">
	<script>
		var html=document.documentElement;
		var viewport=html.clientWidth;
		// console.log(viewport);
		// console.log(html.offsetWidth);
		// console.log(window.innerWidth);
		html.style.fontSize=viewport<=1200&&viewport/16+"px";
	</script>

	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-159827935-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-159827935-1');
	</script>
</head>
<body>
	<!-- 头部 S -->
	<div class="header">
		<div class="header-body">
			<div class="logo">
				<a href="index.html"><img src="img/logo.png"></a>
			</div>
			<div class="menu"><img src="img/menu.png" alt=""></div>
			<div class="about-us">
				<a href="about-us.html"
				onclick="sendEventBeforeJump(event,
				gtag.bind(window,'event', 'click', {'event_category': 'about-us','event_label': 'item-list'}))">ABOUT US</a>
			</div>
		</div>
	</div>
	<!-- 头部 E -->

	<!-- 导航 S -->
	<div class="nav">
		<ul id="nav-body">
		</ul>
	</div>
	<!-- 导航 E -->

	<!-- PATH S -->
	<div class="path">
		<div id="path-body">
			
		</div>
	</div>
	<!-- PATH E -->

	<!-- TAB S -->
	<ul id="tab">
	</ul>
	<!-- TAB E -->

	<!-- main S -->
	<div class="main">
		<ul id="main-body">
		</ul>
		<p class="end-note">—— END ——</p>
	</div>
		
	<!-- main E -->

	<!-- 遮罩层 S -->
	<div class="detail-cover-bg">
		<div class="detail-cover">
			<dl id="detail-cover-body">
			</dl>
			<span class="icon-close"></span>
		</div>
	</div>
	<!-- 遮罩层 E -->

	<!-- 版权声明 S -->
	<div class="copyright">
		<p class="copyright-body">©2017 by HOPEShardware. All rights reserved.</p>
	</div>
	<!-- 版权声明 E -->

	<script src="js/data.json"></script>
	<script src="js/getData.js"></script>
	<script src="js/common.js"></script>
	<script>
		var tabTplStr="<li data-id='{{id}}' class='{{hidden}}'><a href='#{{id}}' onclick='"+'gtag("event", "click", {"event_category": "3rd cate","event_label": "{{name}}"})'+"'>{{name}}</a></li>";
		var itemTplStr="<li onclick='"+'gtag("event", "click", {"event_category": "product","event_label": "{{title}}"})'+"'><a href='javascript:' data-id='{{id}}'><img src='{{img}}'></a><p>{{title}}</p></li>";
		var detailImgTplStr="<dt class='item-img'><img src='{{img}}'></dt>";
		var detailTxtTplStr="<ul><li>{{key}}</li><li>{{value}}</li></ul>";
		var foldId=searchStrObj.foldId===undefined?0:searchStrObj.foldId;
		var tabId=location.hash?location.hash.substr(1):0;
		var foldData=data[navId].children[foldId];
		var tabData=data[navId].children[foldId].children;
		var hasTabData=tabData[0].class==="third";//运算符优先级
		var itemData=hasTabData?foldData.children[tabId].children:foldData.children;
		var close=document.getElementsByClassName("icon-close")[0];
		var detailCover=document.getElementsByClassName("detail-cover-bg")[0];
		var cover=document.getElementById("detail-cover-body");
		var navs,tabs;

		// console.log("foldId:"+foldId);
		// console.log("tabId:"+tabId);
		// 加载路径
		document.getElementById("path-body").innerHTML="<a href='index.html?navId="+navId+"' onclick='sendEventBeforeJump(event,gtag.bind(window,'event', 'click', {'event_category': '3rd cate','event_label': '"+data[navId].name+"'}))'>"+data[navId].name+"</a><span class='icon-arrow'></span><span class='blue'>"+data[navId].children[foldId].name+"</span>";


		// 加载选项卡
		if(hasTabData){
			appendTpl(tabData,"tab",tabTplStr);
			// 默认选中选项卡第一项
			tabs=document.querySelectorAll("#tab li");
			tabs[tabId].setAttribute("class","selected");
			// 获取nav数组
			tabs=document.querySelectorAll("#tab li");
			tabs=Array.prototype.slice.call(tabs);
		}else{
			document.getElementById("tab").style.display="none";
		}
		
		// 加载商品列表
		var pageSize=12,pageNum=1,
		mainContent=document.getElementsByClassName('main')[0],
		endNote=document.getElementsByClassName('end-note')[0],
		clientH=window.innerHeight,
		distance=50
		loadItems()
		checkLoad()
		addScrollListner()

		// nav绑定click
		if(tabs!==undefined){
			tabs.map(function(current,index){
				current.onclick=function(){
					tabs=Array.prototype.slice.call(tabs);
					tabs.map(function(current,j){
						j==index?current.setAttribute("class","selected"):current.removeAttribute("class");
					})
					pageNum=1
					itemData=foldData.children[index].children;
					loadItems()
					checkLoad()
					addScrollListner()
				}
			})
		}

		// 分页：滚动加载
		function addScrollListner(){
			var timer=null
			window.onscroll=function(){
				clearTimeout(timer)
				timer=null
				timer=setTimeout(checkLoad,200)
			}
		}

		// 全部加载完成，取消滚动监听
		function removeScrollListner(){
			window.onscroll=null
		}

		// 判断是否需要加载下一页
		function checkLoad(){
			console.log(itemData.length)
			clientH=window.innerHeight
			if(mainContent.getBoundingClientRect().bottom-distance<clientH && pageNum*pageSize<itemData.length){
				pageNum++
				loadItems()
				checkLoad()
			}else if(pageNum*pageSize>=itemData.length){
				endNote.style.display="block"
				removeScrollListner()
			}
		}
		
		// 加载列表
		function loadItems(){
			appendTpl(itemData.slice(0,pageNum*pageSize),"main-body",itemTplStr);
			// item绑定click
			bindItemClick();
		}

		// nav绑定click
		function bindItemClick(){
			var items=document.querySelectorAll("#main-body a");
			items=Array.prototype.slice.call(items);
			items.map(function(current,index){
				// console.log(data);
				current.onclick=function(){
					var item=itemData[index];
					item.detail[0].txt.unshift({
						key:'Name',
						value:item.title
					})
					var htmlList=[];
					// 加载商品详情
					htmlList=repeatTpl(item.detail,detailImgTplStr).concat("<dd id='item-descrip'>",repeatTpl(item.detail[0].txt,detailTxtTplStr),"</dd>");
					cover.innerHTML=htmlList.join("");
					detailCover.style.display="block";
				}
			})
			detailCover.onclick=close.onclick=function(){
				detailCover.style.display="none";
			}
		}
	</script>

</body>
</html>